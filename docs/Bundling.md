---
id: bundling
title: 构建
---

构建时，每个模块都会分配一个数字 ID，这意味着不支持动态引入。引入会因其数字版本而改变，模块可能以不同的格式存储。支持三种不同的构建方式：

## 普通 bundle

这是标准的构建方式。在这种格式中，所有文件都用函数调用包装，然后添加到全局文件中。这对于期望只是用 JS bundle 的环境（例如，浏览器）很有用处。仅仅需要具有 `.bundle` 后缀的入口起点应该使用该方式构建。

## RAM 索引 bundle

这种格式将 bundle 组成一个二进制文件，该格式包含以下部分（所有数字都使用小字符顺序表示）：

* 魔术数字（译注，一般是指硬写到代码里的整数常量）: `uint32` 必须位于文件的开头，值为 `0xFB0BD1E5`。这用于校验文件。
* 偏移表: 该表是一系列 `uint32` 数值对，带有 header
    * 对于 header，可以找到两个 `uint32`：header 的长度和 startup 的长度
    * 对于数值对，它们表示文件中的偏移量和代码模块的长度，以字节为单位。
* 每个模块，由空字节（`\0`）结束。

```
` 0                   1                   2                   3                   4                   5                   6
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Magic number                         |                          Header size                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Startup code size                       |                        Module 0 offset                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Module 0 length                        |                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                                               +
|                                                                                                                               |
+                                                              ...                                                              +
|                                                                                                                               |
+                                                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |                        Module n offset                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Module n length                        | Module 0 code | Module 0 code |      ...      |       \0      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Module 1 code | Module 1 code |      ...      |       \0      |                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                                               +
|                                                                                                                               |
+                                                              ...                                                              +
|                                                                                                                               |
+                                                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               | Module n code | Module n code |      ...      |       \0      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+`
```

这种结构对于能在内存一次加载所有代码的环境来说是最佳的：

* 通过使用偏移量表，可以在恒定时间内加载任何模块，其中模块 `x` 的代码位于 `file[(x + 3) * sizeof(uint32)]` 的位置。由于存在分隔模块的空字符串（`\0`），通常不需要使用长度，并且模块可以直接作为 ASCIIZ 字符串加载。
* Startup 代码能在 `file[sizeof(uint 32)]` 中找到。

这种构建方式通常用于 iOS。

## 文件 RAM bundle

每个模块都存储为一个文件，名称为 `js-modules/${id}.js`，另外还创建一个名为 `UNBUNDLE` 的额外文件，其中唯一的内容是魔术数字，`0xFB0BD1E5`。请注意，`UNBUNDLE` 文件是在根目录下创建的。
这种构建方式通常用于 Android，因为包内容是压缩的，并且对压缩文件的访问会更快。如果使用索引方式，则应对所有 bundle 的内容进行解压缩，以获取相应模块的代码。
